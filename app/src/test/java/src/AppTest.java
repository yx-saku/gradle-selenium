/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package src;

import static com.codeborne.selenide.Selenide.$;
import static com.codeborne.selenide.Selenide.$$;
import static com.codeborne.selenide.Selenide.open;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.Properties;

import javax.imageio.ImageIO;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import com.codeborne.selenide.CollectionCondition;
import com.codeborne.selenide.Configuration;
import com.codeborne.selenide.Selenide;
import com.codeborne.selenide.logevents.SelenideLogger;

import io.github.bonigarcia.wdm.WebDriverManager;
import io.qameta.allure.Allure;
import io.qameta.allure.selenide.AllureSelenide;
import ru.yandex.qatools.ashot.AShot;
import ru.yandex.qatools.ashot.Screenshot;
import ru.yandex.qatools.ashot.shooting.ShootingStrategies;

class AppTest {
    @BeforeAll
    public static void setUp() {
        SelenideLogger.addListener("AllureSelenide", new AllureSelenide());
        WebDriverManager.chromedriver().setup();
        WebDriverManager.firefoxdriver().setup();
        WebDriverManager.edgedriver().setup();

        Properties properties = new Properties();

        // 環境情報を追加
        properties.setProperty("os.name", System.getProperty("os.name"));
        properties.setProperty("os.version", System.getProperty("os.version"));
        properties.setProperty("java.version", System.getProperty("java.version"));

        // その他の環境情報を追加する場合、以下のように記述
        // properties.setProperty("key", "value");

        // allure-resultsディレクトリにenvironment.propertiesファイルを作成
        String allureResultsPath = Paths.get("allure-results").toAbsolutePath().toString();
        try (FileOutputStream outputStream = new FileOutputStream(allureResultsPath + "/environment.properties")) {
            properties.store(outputStream, "Environment properties");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Test
    void openUrl() throws IOException {
        // Open Google search page
        open("https://www.google.com");

        // Type "Hello, world!" in the search box and submit
        $("[name=q]")
                .setValue("Hello, world!!!!!!! " + Configuration.browser + " " + System.getProperty("selenide.browser"))
                .pressEnter();

        // Check if search results are displayed
        $$("#search .g").shouldHave(CollectionCondition.sizeGreaterThan(0));

        Screenshot screenshot = new AShot()
                .shootingStrategy(ShootingStrategies.viewportPasting(100))
                .takeScreenshot(Selenide.webdriver().object());

        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {
            ImageIO.write(screenshot.getImage(), "PNG", outputStream);
            Allure.addAttachment("キャプチャ", new ByteArrayInputStream(outputStream.toByteArray()));
        }
    }
}
