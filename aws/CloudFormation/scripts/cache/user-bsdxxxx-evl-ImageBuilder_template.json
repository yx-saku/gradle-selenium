{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Mappings": {
        "Env": {
            "443244910989": {
                "Name": "evl"
            }
        }
    },
    "Resources": {
        "ECRRepository": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-ecrrepository",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "LifecyclePolicy": {
                    "LifecyclePolicyText": "{\r\n  \"rules\": [\r\n    {\r\n      \"rulePriority\": 1,\r\n      \"description\": \"タグが付いていないイメージは1つのみ保持する\",\r\n      \"selection\": {\r\n        \"tagStatus\": \"untagged\",\r\n        \"countType\": \"imageCountMoreThan\",\r\n        \"countNumber\": 1\r\n      },\r\n      \"action\": {\r\n        \"type\": \"expire\"\r\n      }\r\n    }\r\n  ]\r\n}"
                }
            }
        },
        "ContainerRecipe": {
            "UpdateReplacePolicy": "Delete",
            "Type": "AWS::ImageBuilder::ContainerRecipe",
            "Properties": {
                "Name": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-ContainerRecipe",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "Version": "1.0.1",
                "ParentImage": {
                    "Fn::Sub": "arn:aws:imagebuilder:${AWS::Region}:aws:image/amazon-linux-x86-2/2023.9.23"
                },
                "ContainerType": "DOCKER",
                "DockerfileTemplateUri": "s3://user-bsdxxxx-evl-cf-packages/1a3bfac691bc4b7f2cf069ce73bf629ee075671b9cd88d25899aceb0dfeab2c6",
                "TargetRepository": {
                    "RepositoryName": {
                        "Ref": "ECRRepository"
                    },
                    "Service": "ECR"
                },
                "Components": [
                    {
                        "ComponentArn": {
                            "Ref": "CommonComponent"
                        },
                        "Parameters": [
                            {
                                "Name": "BucketName",
                                "Value": [
                                    {
                                        "Fn::ImportValue": "BucketName"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        "CommonComponent": {
            "Type": "AWS::ImageBuilder::Component",
            "Properties": {
                "Name": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-CommonComponent",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "Version": "1.0.0",
                "Platform": "Linux",
                "Uri": "s3://user-bsdxxxx-evl-cf-packages/28cfdf9d6b1796af240a0ced798f85230d25507ff5ad32aff16fc8b1ebace705"
            }
        },
        "ImageBuilderRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-ImageBuilderRole",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
                ]
            }
        },
        "ImageBuilderInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "ImageBuilderRole"
                    }
                ]
            }
        },
        "InfrastructureConfiguration": {
            "Type": "AWS::ImageBuilder::InfrastructureConfiguration",
            "Properties": {
                "Name": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-InfrastructureConfiguration",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "InstanceProfileName": {
                    "Ref": "ImageBuilderInstanceProfile"
                },
                "TerminateInstanceOnFailure": true,
                "InstanceTypes": [
                    "t2.micro"
                ],
                "Logging": {
                    "S3Logs": {
                        "S3BucketName": {
                            "Fn::ImportValue": "BucketName"
                        },
                        "S3KeyPrefix": "/logs/ImageBuilder/"
                    }
                }
            }
        },
        "ImagePipeline": {
            "Type": "AWS::ImageBuilder::ImagePipeline",
            "Properties": {
                "Name": {
                    "Fn::Sub": [
                        "user-bsdxxxx-${Env}-ImagePipeline",
                        {
                            "Env": {
                                "Fn::FindInMap": [
                                    "Env",
                                    {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "Name"
                                ]
                            }
                        }
                    ]
                },
                "ContainerRecipeArn": {
                    "Ref": "ContainerRecipe"
                },
                "InfrastructureConfigurationArn": {
                    "Ref": "InfrastructureConfiguration"
                }
            }
        }
    },
    "Outputs": {
        "ECRRepositoryArn": {
            "Value": {
                "Fn::GetAtt": [
                    "ECRRepository",
                    "Arn"
                ]
            },
            "Export": {
                "Name": "ECRRepositoryArn"
            }
        },
        "ECRRepositoryUri": {
            "Value": {
                "Fn::GetAtt": [
                    "ECRRepository",
                    "RepositoryUri"
                ]
            },
            "Export": {
                "Name": "ECRRepositoryUri"
            }
        }
    }
}
